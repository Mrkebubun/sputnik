var session=null,base_uri="http://example.com/",get_chat_history_URI=base_uri+"procedures/get_chat_history",safe_price_URI=base_uri+"safe_price",get_safe_prices_URI=base_uri+"procedures/get_safe_prices",place_order_URI=base_uri+"procedures/place_order",get_trade_history_URI=base_uri+"procedures/get_trade_history",markets_URI=base_uri+"procedures/list_markets",positions_URI=base_uri+"procedures/get_positions",get_order_book_URI=base_uri+"procedures/get_order_book",make_account_URI=base_uri+"procedures/make_account",
get_open_orders_URI=base_uri+"procedures/get_open_orders",cancel_order_URI=base_uri+"procedures/cancel_order",register_two_factor_URI=base_uri+"procedures/register_two_factor",get_new_two_factor_URI=base_uri+"procedures/get_new_two_factor",disable_two_factor_URI=base_uri+"procedures/disable_two_factor",change_password_URI=base_uri+"procedures/change_password",get_new_address_URI=base_uri+"procedures/get_new_address",get_current_address_URI=base_uri+"procedures/get_current_address",withdraw_URI=base_uri+
"procedures/withdraw",AUTHEXTRA={keylen:32,salt:"RANDOM SALT",iterations:1E4};
function connect(){var a;a="file:"===window.location.protocol?"ws://localhost:9000":"ws://"+window.location.hostname+":9000";ab.connect(a,function(d){session=d;ab.log("connected to "+a);onConnect()},function(a,e,c){$("#loggedOut").modal("show");logout();session=null;switch(a){case ab.CONNECTION_UNSUPPORTED:window.location="http://autobahn.ws/unsupportedbrowser";break;case ab.CONNECTION_CLOSED:window.location.reload();break;default:ab.log(a,e,c)}},{maxRetries:1,retryDelay:1E3})}
function do_login(a,d){session.authreq(a).then(function(a){AUTHEXTRA=JSON.parse(a).authextra;console.log("challenge",JSON.parse(a).authextra);console.log(ab.deriveKey(d,JSON.parse(a).authextra));console.log(two_factor.value);var c=two_factor.value+ab.deriveKey(d,JSON.parse(a).authextra),c=ab.deriveKey(c,{iterations:10,keylen:32,salt:"onetimepass"});console.log(a);console.log(session.authsign(a,c));a=session.authsign(a,c);console.log(a);session.auth(a).then(onAuth,failed_login);console.log("end of do_login")},
function(a){failed_login("bad login")})}function failed_login(a){$(".modal-backdrop").removeAttr("class","in");$("#login_error").attr("class","alert").text("Login error, please try again.");$("#loginButton").click()}function logout(){logged_in=!1;$("#loggedInMenu").hide();$("#dLabel").text("");$("#loginButton").show();$("#registration").show();$("#PennyArcade").click();$(".table").empty();SITE_POSITIONS=[];OPEN_ORDERS=[];AUTHEXTRA={};console.log(OPEN_ORDERS);session.close()}
function getTradeHistory(a){a=new Date;(new Date(a.getTime())).setDate(a.getDate()-7);session.call(get_trade_history_URI,SITE_TICKER,604800).then(function(a){build_trade_graph(a);TRADE_HISTORY=a.reverse();tradeTable(TRADE_HISTORY,!0)})}function getChatHistory(){session.call(get_chat_history_URI).then(function(a){for(chat in a)CHAT_MESSAGES.push(a[chat]);$("#chatArea").html(CHAT_MESSAGES.join("\n"));$("#chatArea").scrollTop($("#chatArea")[0].scrollHeight)})}
function placeOrder(a){notifications.processing(a);session.call(place_order_URI,a).then(function(a){notifications.dismiss_processing(a);!1==a&&notifications.orderError()})}function cancelOrder(a){session.call(cancel_order_URI,a).then(function(d){$("#cancel_order_row_"+a).addClass("warning");$("#cancel_button_"+order_id).attr("disabled","disabled").removeClass("btn-danger")})}
function getPositions(){session.call(positions_URI).then(function(a){SITE_POSITIONS=a;var d={},e={},c=_.pluck(OPEN_ORDERS,"ticker"),b;for(b in a)if("cash"==a[b].contract_type)d[b]=a[b];else if(0!=a[b].position||_.contains(c,a[b].ticker))e[b]=a[b];displayCash(!0,d);displayCash(!1,d);displayPositions(!0,e);displayPositions(!1,e)})}
function orderBook(a){console.log("in orderBook");session.call(get_order_book_URI,a).then(function(a){ORDER_BOOK=a;for(var e=[],c=[],b=0;b<a.length;b++)(0==a[b].order_side?e:c).push([Number(a[b].price),a[b].quantity]);e=stackBook(e);c=stackBook(c);c.reverse();graphTable(e,"buy",!0);graphTable(c,"sell",!0);suggestOrder()})}function withdraw(){session.call(withdraw_URI,"BTC",withdrawAddress.value,Math.round(1E8*Number(withdrawAmount.value))).then(function(a){console.log(a)})}
function getCurrentAddress(){session.call(get_current_address_URI).then(function(a){console.log(a);$("#deposit_address").attr("href","bitcoin:"+a).text(a);$("#qrcode").empty();new QRCode(document.getElementById("qrcode"),"bitcoin:"+a)})}
function change_password(a,d){old_password_hash=ab.deriveKey(a,AUTHEXTRA);new_password_hash=ab.deriveKey(d,AUTHEXTRA);console.log(old_password_hash);session.call(change_password_URI,old_password_hash,new_password_hash).then(function(a){a?(alert("success!"),$(".modal").modal("hide")):alert("password reset failed")})}function getNewAddress(){session.call(get_new_address_URI).then(function(a){console.log(a)})}
function registerTwoFactor(a){notifications.processing("confirmation");session.call(register_two_factor_URI,a).then(function(a){notifications.dismiss_processing(a);console.log(a);a&&(two_factor.value="enabled",TWO_FACTOR_ON=!0,twoFactorSetting())})}function disableTwoFactor(a){session.call(disable_two_factor_URI,a).then(function(a){a&&(console.log("disabled"),two_factor.value="",TWO_FACTOR_ON=!1,twoFactorSetting())})}
function getNewTwoFactor(){session.call(get_new_two_factor_URI).then(function(a){console.log(a);console.log("otpauth://totp/Sputnik:"+login.value+"?secret="+a+"&issuer=SputnikMKT");$("#twoFactor").empty();new QRCode(document.getElementById("twoFactor"),"otpauth://totp/Sputnik:"+login.value+"?secret="+a+"&issuer=SputnikMKT")})}
function getOpenOrders(){console.log("Making getOpenOrders RPC call");session.call(get_open_orders_URI).then(function(a){console.log("Ended RPC call, drawing");OPEN_ORDERS=a;displayOrders(!0,a);displayOrders(!1,a)})}
function getMarkets(){console.log("in getMarkets");session.call(markets_URI).then(function(a){newMarketsToDisplay(a);MARKETS=a;welcome(MARKETS);$("#search").typeahead({source:_.keys(MARKETS)});a=[];for(key in MARKETS)a.push(key);setSiteTicker(a[Math.floor(a.length*Math.random())]);for(key in MARKETS)"futures"==MARKETS[key].contract_type&&session.subscribe(safe_price_URI+"#"+key,onSafePrice);console.log(SITE_TICKER)})}
function getSafePrices(){session.call(get_safe_prices_URI,[]).then(function(a){SAFE_PRICES=a})}function makeAccount(a,d,e,c){var b=Math.random().toString(36).slice(2);AUTHEXTRA.salt=b;d=ab.deriveKey(d,AUTHEXTRA);session.call(make_account_URI,a,d,b,e,c).then(function(a){console.log(a);login.value=registerLogin.value;do_login(registerLogin.value,registerPassword.value)})};
