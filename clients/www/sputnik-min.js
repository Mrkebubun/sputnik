var session=null,logged_in=!1,QBUY,QSELL,PBUY,PSELL,MARKETS,SITE_TICKER="ERROR",TRADE_HISTORY=[],MAX_CHAT_LINES=100,SITE_POSITIONS=[],OPEN_ORDERS=[],ORDER_BOOK,ORDER_BOOK_VIEW_SIZE=!1,CHAT_MESSAGES=[],SAFE_PRICES={},TWO_FACTOR_ON=!1,base_uri="https://example.com/",myTopic=base_uri+"topics/mytopic1",chat_URI=base_uri+"user/chat",fills_URI=base_uri+"user/fills#",cancels_URI=base_uri+"user/cancels#",open_orders_URI=base_uri+"user/open_orders#",trade_URI=base_uri+"trades#",safe_prices_URI=base_uri+"safe_prices#",
order_book_URI=base_uri+"order_book#";window.onload=function(){connect()};function onChat(a,b){CHAT_MESSAGES.push(b[0]+":"+b[1]);CHAT_MESSAGES.length>MAX_CHAT_LINES&&CHAT_MESSAGES.shift();$("#chatArea").html(CHAT_MESSAGES.join("\n"));$("#chatArea").scrollTop($("#chatArea")[0].scrollHeight)}function onSafePrice(a,b){var c=a.split("#")[1];SAFE_PRICES[c]=b}function onConnect(){console.log("Connected!");getMarkets();getChatHistory();session.subscribe(chat_URI,onChat)}
function twoFactorSetting(){console.log(two_factor.value.length);console.log(0<two_factor.value.length);0<two_factor.value.length&&(TWO_FACTOR_ON=!0);TWO_FACTOR_ON?($("#enableTwoFactor").removeClass("btn-success").addClass("btn-danger").text("Disable"),$("#twoFactor").hide(),$("#twoFactorInstructions").text("Enter your current otp number here disable two factor authentication:")):($("#enableTwoFactor").removeClass("btn-danger").addClass("btn-success").text("Enable"),$("#twoFactor").show(),$("#twoFactorInstructions").text("Enter the otp number here to enable two factor:"))}
function onAuth(a){ab.log("authenticated!",JSON.stringify(a));logged_in=!0;$("#loggedInMenu").show();$("#dLabel").text("logged in as "+login.value);$("#loginButton").hide();$("#registration").hide();$(".modal").modal("hide");getSafePrices();getOpenOrders();getPositions();twoFactorSetting();a=_.pluck(a.pubsub,"uri")[1].split("#")[1];console.log(cancels_URI+a);try{session.subscribe(cancels_URI+login.value,onCancel)}catch(b){console.log(b)}try{session.subscribe(fills_URI+login.value,onFill)}catch(c){console.log(c)}try{session.subscribe(open_orders_URI+
login.value,onOpenOrder)}catch(d){console.log(d)}switchBookSub(SITE_TICKER);session.subscribe(chat_URI,onChat)}function onEvent(a,b){console.log("in onEvent",SITE_TICKER,a,b);SITE_TICKER in JSON.parse(b)&&(console.log("got event"),orderBook(SITE_TICKER))}function onBookUpdate(a,b){console.log("in onBookUpdate");ORDER_BOOK=JSON.parse(b);updateOrderBook(ORDER_BOOK,ORDER_BOOK_VIEW_SIZE)}
function onFill(a,b){console.log("in onFill",SITE_TICKER,a,b);getPositions(SITE_TICKER);getSafePrices(Object.keys(MARKETS));OPEN_ORDERS=_.reject(OPEN_ORDERS,function(a){return a.order_id==b.order});displayPositions(!1,SITE_POSITIONS);displayPositions(!0,SITE_POSITIONS);displayOrders(!1,OPEN_ORDERS);displayOrders(!0,OPEN_ORDERS)}
function onOpenOrder(a,b){console.log("in onOpenOrder",SITE_TICKER,a,b);getSafePrices(Object.keys(MARKETS));OPEN_ORDERS.push({order_id:b.order,price:b.price,quantity:b.quantity,side:0==b.side?"BUY":"SELL",ticker:b.ticker});getPositions();displayOrders(!1,OPEN_ORDERS);displayOrders(!0,OPEN_ORDERS)}
function onCancel(a,b){console.log("in onCancel",SITE_TICKER,a,b);OPEN_ORDERS=_.reject(OPEN_ORDERS,function(a){return a.order_id==b.order});displayPositions(!1,SITE_POSITIONS);displayPositions(!0,SITE_POSITIONS);OPEN_ORDERS=_.reject(OPEN_ORDERS,function(a){return a.order_id==b.order});displayOrders(!1,OPEN_ORDERS);displayOrders(!0,OPEN_ORDERS)}
function onTrade(a,b){console.log("in onTrade",SITE_TICKER,a,b);getSafePrices(Object.keys(MARKETS));now=(new Date).toLocaleTimeString();updateTradeTable([now,b.price,b.quantity])}function subToTradeStream(a){console.log(trade_URI+a,onTrade);session.subscribe(trade_URI+a,onTrade)}function subToSafePrice(a){console.log(safe_prices_URI+a,onSafePrice);session.subscribe(safe_prices_URI+a,onSafePrice)}
function subToOrderBook(a){console.log(order_book_URI+a,onBookUpdate);session.subscribe(order_book_URI+a,onBookUpdate)}function subToOpenOrders(a){console.log(open_orders_URI+a,onOpenOrder);session.subscribe(open_orders_URI+a,onOpenOrder)}function subToFills(a){console.log(fills_URI+a,onFill);session.subscribe(fills_URI+a,onFill)}function subToCancels(a){console.log(cancels_URI+a,onCancel);session.subscribe(cancels_URI+a,onCancel)}function sendChat(a){session.publish(chat_URI,a,!1)}
function setSiteTicker(a){SITE_TICKER=a;$(".contract_unit").text("futures"==MARKETS[SITE_TICKER].contract_type?"\u0e3f":"%")}function deposit(){getCurrentAddress();$("#depositModal").modal("show")}function withdrawModal(){$("#withdrawModal").modal("show")}
function calculateMargin(a,b,c){var d=0,e=0,g={},n;for(n in a){var f=a[n];if("cash"!=f.contract_type&&f.ticker in MARKETS){for(var k=f.position,l=f.position,h=0;h<b.length;++h){var m=b[h];m.ticker==f.ticker&&("BUY"==m.side&&(k+=m.quantity),"SELL"==m.side&&(l-=m.quantity))}if("futures"==MARKETS[f.ticker].contract_type){var h=c[f.ticker],p=Math.abs(k)*MARKETS[f.ticker].margin_low*h/100+k*(f.reference_price-h),q=Math.abs(l)*MARKETS[f.ticker].margin_low*h/100+l*(f.reference_price-h),r=Math.abs(k)*MARKETS[f.ticker].margin_high*
h/100+k*(f.reference_price-h),h=Math.abs(l)*MARKETS[f.ticker].margin_high*h/100+l*(f.reference_price-h),e=e+Math.max(r,h),d=d+Math.max(p,q);g[f.ticker]=[Math.max(r,h),Math.max(p,q)]}if("prediction"==MARKETS[f.ticker].contract_type){r=MARKETS[f.ticker].final_payoff;for(h=q=p=0;h<b.length;++h)m=b[h],m.ticker==f.ticker&&("BUY"==m.side&&(p+=m.quantity*m.price),"SELL"==m.side&&(q+=m.quantity*m.price));l=Math.max(-l,0)*r;k=Math.max(-k,0)*r;k=Math.max(p+k,-q+l);d+=k;e+=k;g[f.ticker]=[k,k]}}}g.total=[d,e];
return g}function decimalPlacesNeeded(a){for(var b=0,c=0;0==a%5;)++b,a/=5;for(;0==a%2;)++c,a/=2;return Math.max(b,c)}function stackBook(a){var b=[];a.sort(function(a,b){return parseFloat(a[0])-parseFloat(b[0])});if(0==a.length)return[];for(var c=a[0][0],d=a[0][1],e=1;e<a.length;e++)a[e][0]==c?d+=a[e][1]:(b.push([d,c]),c=a[e][0],d=a[e][1]);b.push([d,c]);return b}
function build_trade_graph(a){for(var b=d3.time.format("%Y-%m-%dT%H:%M:%S").parse,c=[],d=0;d<a.length;++d)c.push({date:b(a[d][0].split(".")[0]),price:a[d][1]/MARKETS[SITE_TICKER].denominator,quantity:a[d][2]});a=crossfilter(c).dimension(function(a){return a.date});var b=a.group().reduceSum(function(a){return a.quantity}),d=a.group().reduce(function(a,b){a.total_volume+=b.quantity;a.price_volume_sum_product+=b.price*b.quantity;a.volume_weighted_price=a.price_volume_sum_product/a.total_volume;return a},
function(a,b){a.total_volume-=b.quantity;a.price_volume_sum_product-=b.price*b.quantity;a.volume_weighted_price=a.price_volume_sum_product/a.total_volume;return a},function(){return{total_volume:0,price_volume_sum_product:0,volume_weighted_price:NaN}}),e=dc.compositeChart("#monthly-move-chart"),g=dc.barChart("#monthly-volume-chart");d3.format(".2f");d3.time.format("%Y-%M-%dT%H:%M:%S");e.width(700).height(180).transitionDuration(1E3).margins({top:10,right:50,bottom:25,left:40}).dimension(a).group(d).valueAccessor(function(a){return a.value.volume_weighted_price}).mouseZoomable(!0).x(d3.time.scale().domain([c[0].date,
c[c.length-1].date])).round(d3.time.minutes.round).xUnits(d3.time.minutes).elasticY(!0).yAxisPadding("20%").renderHorizontalGridLines(!0).brushOn(!1).rangeChart(g).compose([dc.lineChart(e).group(d).valueAccessor(function(a){return a.value.volume_weighted_price}).renderArea(!0)]).xAxis();g.width(700).height(50).margins({top:0,right:50,bottom:20,left:40}).dimension(a).group(b).centerBar(!0).gap(1).x(d3.time.scale().domain([c[0].date,c[c.length-1].date])).round(d3.time.minute.round).xUnits(d3.time.minutes);
dc.renderAll()}function displayPrice(a,b,c,d){var e="\u0e3f",g=1;"prediction"==d&&(e="%",g=100);c=decimalPlacesNeeded(b/(g*c));return(a*g/b).toFixed(c)+" "+e}function updateOrderBook(a,b){console.log("in updateOrderBook");for(key in a){a=a[key];for(var c=[],d=[],e=0;e<a.length;e++)(0==a[e].order_side?c:d).push([Number(a[e].price),a[e].quantity]);c=stackBook(c);d=stackBook(d);d.reverse();graphTable(c,"buy",!0);graphTable(d,"sell",!0)}}
function updateTradeTable(a){console.log("recieved trade");console.log(a);var b="";a[1]>TRADE_HISTORY[0][1]?b="success":a[1]<TRADE_HISTORY[0][1]&&(b="error");$("#tradeHistory tr:first").after("<tr class="+b+"><td>"+displayPrice(a[1],MARKETS[SITE_TICKER].denominator,MARKETS[SITE_TICKER].tick_size,MARKETS[SITE_TICKER].contract_type)+"</td><td>"+a[2]+"</td><td>"+a[0]+"</td></tr>");TRADE_HISTORY.push(a)}
function tradeTable(a,b){console.log("in tradeTable");$("#tradeHistory").empty();var c="neutral";b||(a=a.slice(0,25));a.reverse();for(var d=1;d<a.length;d++)a[d][1]>a[d-1][1]?c="success":a[d][1]<a[d-1][1]&&(c="error"),$("#tradeHistory").prepend("<tr class="+c+"><td>"+displayPrice(a[d][1],MARKETS[SITE_TICKER].denominator,MARKETS[SITE_TICKER].tick_size,MARKETS[SITE_TICKER].contract_type)+"</td><td>"+a[d][2]+"</td><td>"+(new Date(a[d][0])).toLocaleTimeString()+"</td></tr>");a.reverse();$("#tradeHistory").prepend("<tr><th>Price <p class='contract_unit'></p> </th><th>Vol.</th><th>Time</th></tr>");
$("#lessTrades").click(function(){tradeTable(TRADE_HISTORY,!1)});$("#moreTrades").click(function(){tradeTable(TRADE_HISTORY,!0)})}function suggestOrder(){$("#psell").val(PSELL);$("#qsell").val(QSELL);$("#pbuy").val(PBUY);$("#qbuy").val(QBUY)}
function graphTable(a,b,c){console.log("in graphTable");console.log(c);var d=c?a.length:10;c="buy"==b?"#orderBookBuys":"#orderBookSells";var e=MARKETS[SITE_TICKER].denominator,g=MARKETS[SITE_TICKER].contract_type,n=MARKETS[SITE_TICKER].tick_size;$(c).empty();0<a.length&&("buy"==b?(PSELL=displayPrice(a[a.length-1][1],e,n,g).split(" ")[0],QSELL=a[a.length-1][0]):(PBUY=displayPrice(a[a.length-1][1],e,n,g).split(" ")[0],QBUY=a[a.length-1][0]));for(var f=0;f<Math.max(10,d);f++)if(f<a.length){var k=a.length-
f-1,l="<td>"+displayPrice(a[k][1],e,n,g)+"</td>",h="<td>"+a[k][0]+"</td>",l="buy"==b?h+l:l+h;$(c).append("<tr id='"+b+"_"+f+"'>"+l+"</tr>");_.contains(_.pluck(_.filter(OPEN_ORDERS,function(a){return a.ticker==SITE_TICKER}),"price"),a[k][1])&&$("#"+b+"_"+f).addClass("info")}else $(c).append("<tr><td> - </td><td> - </td></tr>");a="<th>"+("buy"==b?"Bid":"Ask")+"<p class='contract_unit'></p> </th>";$(c).prepend("<tr>"+("buy"==b?"<th>Volume</th>"+a:a+"<th>Volume</th>")+"</tr>");$(".lessOrderBook").click(function(){console.log("less");
ORDER_BOOK_VIEW_SIZE=!1;updateOrderBook(ORDER_BOOK,ORDER_BOOK_VIEW_SIZE)});$(".moreOrderBook").click(function(){console.log("more");ORDER_BOOK_VIEW_SIZE=!0;updateOrderBook(ORDER_BOOK,ORDER_BOOK_VIEW_SIZE)})}
function displayOrders(a,b){var c=a?"#openOrders":"#market_order_table";$(c).empty().append("<thead><tr>"+(a?"<th>Ticker</th>":"")+"<th>"+(a?"Quantity":"#")+"</th><th>Price</th><th>Buy/Sell</th><th>Cancel</th></tr></thead><tbody>");_.each(_.groupBy(OPEN_ORDERS,function(a){return a.ticker}),function(b,e){var g=_.size(b);if(a||e==SITE_TICKER){var n=a?"<td rowspan='"+g+"' style='vertical-align:middle' class='ordersDisplay'  id='"+e+"'>"+e+"</td>":"",f;_.each(b,function(b){var d=b.quantity,e=displayPrice(b.price,
MARKETS[b.ticker].denominator,MARKETS[b.ticker].tick_size,MARKETS[b.ticker].contract_type);$(c).append("<tr id='cancel_order_row_"+b.order_id+"'>"+(f?"":n)+"<td>"+d+"</td><td nowrap>"+e+"</td><td>"+b.side+"</td><td><button id='cancel_button_"+b.order_id+"' class='cancelButtons btn btn-block btn-danger' type='button' >"+(a?"cancel":"")+"<i class='icon-trash'/></button></td></tr>");f=!0})}$(c).append("</thead>")});$(".cancelButtons").unbind().click(function(a){cancelOrder(parseInt(a.currentTarget.id.split("_")[2]))});
$(".ordersDisplay").unbind("click").click(function(a){switchToTrade(a.currentTarget.id)})}
function displayCash(a,b){var c=a?"#account_cash_table":"#cash_table",d=calculateMargin(SITE_POSITIONS,OPEN_ORDERS,SAFE_PRICES);$(c).empty().append("<tr><th>Currency</th><th>Position</th><th>Reserved in Margin</th>"+(a?"<th>Withdraw</th><th>Deposit</th>":"")+"</tr>");for(var e in b)$(c).append("<tr><td>"+b[e].ticker+"</td><td>"+b[e].position/1E8+"</td><td>"+d.total[1]/1E8+"</td>"+(a?"<td><button id='withdrawModalButton'  class='btn btn-block' type='button'> <i class='icon-minus-sign'/></button></td><td><button id='depositButton' class='btn btn-block' type='button'> <i class='icon-plus-sign'/></button></td>":"")+
"</tr>");$("#depositButton").click(function(){deposit()});$("#withdrawModalButton").click(function(){withdrawModal()})}
function displayPositions(a,b){var c=a?"#account_positions_table":"#market_position_table",d=calculateMargin(SITE_POSITIONS,OPEN_ORDERS,SAFE_PRICES);$(c).empty().append("<thead><tr>"+(a?"<th>Ticker</th>":"")+"<th>Position</th><th>Reference Price</th><th>Reserved for Margin</th></tr></thead><tbody>");b=_.reject(b,function(a){return"cash"==a.contract_type});b=_.filter(b,function(a){return-1<_.indexOf(Object.keys(d),a.ticker)});for(var e in b)if(a||b[e].ticker==SITE_TICKER){var g=b[e].ticker;$(c).append("<tr>"+
(a?"<td class='positionDisplays' id='"+g+"' >"+g+"</td>":"")+"<td>"+b[e].position+"</td><td>"+b[e].reference_price/1E8+"</td><td>"+d[g][0]/1E8+"</td></tr>")}$(c).append("</tbody>");$(".positionDisplays").unbind();$(".positionDisplays").click(function(a){switchToTrade(a.currentTarget.id)})}
function newMarketsToDisplay(a){a=_.pairs(a);var b=_.filter(a,function(a){return"prediction"==a[1].contract_type});a=_.filter(a,function(a){return"futures"==a[1].contract_type});var c=[];for(market in b)c.push("<li><a class='newMarkets' id='"+b[market][0]+"' href='#'> <small style='padding-right:1em;'>"+b[market][0]+"</small>"+b[market][1].description+"</a></li>");b=[];for(market in a)b.push("<li><a class='newMarkets' id='"+a[market][0]+"' href='#'><small style='padding-right:1em;'>"+a[market][0]+
"</small>"+a[market][1].description+"</a></li>");$("#marketsDropDown").html('<li class="nav-header">Predictions</li>'+c.join("")+'<li class="nav-header">Futures</li>'+b.join(""));$(".newMarkets").unbind();$(".newMarkets").click(function(a){switchToTrade(a.currentTarget.id)})}
function welcome(a){$("#welcome").empty();$("#welcome").append("<thead><tr><th>Most Active Markets</th><th>Description</th></tr></thead>");for(row in a)$("#welcome").append("<tr class='splash' id='"+row+"' ><td>"+row+"</td><td>"+a[row].description+"</td></tr>");$(".splash").unbind();$(".splash").click(function(a){switchToTrade(a.target.parentNode.id)});a=$(window).height()/$(window).width();$("#splash").css("z-index","-1").css("width",parseInt(0.55*100*a)+"%").css("position","absolute").css("top",
"15%").css("right","5%").show()}function switchToTrade(a){console.log("in switchToTrade");switchBookSub(a);$("#Trade").click()}
function switchBookSub(a){id="USD.13.7.31"==SITE_TICKER?17:16;if(logged_in){try{session.unsubscribe(order_book_URI+SITE_TICKER,onBookUpdate)}catch(b){console.log(b)}try{session.unsubscribe(trade_URI+SITE_TICKER,onTrade)}catch(c){console.log(c)}try{session.unsubscribe(safe_prices_URI+SITE_TICKER,onSafePrice)}catch(d){console.log(d)}}setSiteTicker(a);id="USD.13.7.31"==SITE_TICKER?17:16;try{session.subscribe(order_book_URI+SITE_TICKER,onBookUpdate)}catch(e){console.log(e)}try{session.subscribe(trade_URI+
SITE_TICKER,onTrade)}catch(g){console.log(g)}try{session.subscribe(safe_prices_URI+SITE_TICKER,onSafePrice)}catch(n){console.log(n)}}var notifications={orderError:function(){alert("Order error: must be between 0.0% and 100.0%")},processing:function(a){$("#processingModal").modal("show")},dismiss_processing:function(a){$(".modal").modal("hide")}};
$("#Trade").click(function(){$("#currentMarket").html(MARKETS[SITE_TICKER].description);$("#currentTicker").html(SITE_TICKER);$("#descriptionText").html(MARKETS[SITE_TICKER].full_description);getTradeHistory(SITE_TICKER);orderBook(SITE_TICKER);logged_in&&(getOpenOrders(),getPositions())});$("#Account").click(function(){getPositions();getOpenOrders();logged_in||$("#loginButton").click()});
$("#logoutButton").click(function(){$("#loggedInMenu").hide();$("#dLabel").text("");logout();$("#loginButton").show();$("#registration").show()});$("#registerButton").click(function(){makeAccount(registerLogin.value,registerPassword.value,registerEmail.value,registerBitMessage.value)});
function orderButton(a,b,c){if(logged_in){var d={};b=Number(b);d.ticker=SITE_TICKER;d.quantity=parseInt(a);a=MARKETS[SITE_TICKER].tick_size;d.price=Math.round(MARKETS[SITE_TICKER].denominator*b/(("prediction"==MARKETS[SITE_TICKER].contract_type?100:1)*a))*a;d.side=c;placeOrder(d)}else $("#loginButton").click()}
function checkOrder(a){var b="buy"==a?pbuy.value:psell.value;a="buy"==a?qbuy.value:qsell.value;return 0==a.length?($(".modal").modal("hide"),alert("Quantity must be non-zero"),!1):isNaN(a)||isNaN(b)?($(".modal").modal("hide"),alert("Please only enter numbers"),!1):0<1E8*parseFloat(b)%MARKETS[SITE_TICKER].tick_size?($(".modal").modal("hide"),alert("The tick size of this contract is: 1/"+1E8/MARKETS[SITE_TICKER].tick_size),!1):!0}
$("#sellButton").click(function(){checkOrder("sell")&&orderButton(qsell.value,psell.value,1)});$("#buyButton").click(function(){checkOrder("buy")&&orderButton(qbuy.value,pbuy.value,0)});$("#chatButton").click(function(){sendChat(chatBox.value);$("#chatBox").val("")});$("#newAddressButton").click(function(){getNewAddress();getCurrentAddress()});$("#chatFooterButton").click(function(){$(".footer").collapse("toggle");$("input#chatBox.chatInput").focus();$("#chatFooterButton").hide()});
$("#minimizeChat").click(function(){$("#chatFooterButton").show();$(".footer").collapse("toggle")});$(".global-modal").on("hidden",function(){logged_in||$("#Sputnik").click()});$("#Sputnik").click(function(){$("li.active").removeAttr("class","active");welcome(MARKETS)});
$("#searchButton").click(function(){"BTC.13.7.12.gt.70"==search.value?($("#USD").hide(),$("#searchPlaceHolder").hide(),$("#BTC").show()):"USD.13.7.31"==search.value?($("#BTC").hide(),$("#searchPlaceHolder").hide(),$("#USD").show()):($("#BTC").hide(),$("#USD").hide(),$("#searchPlaceHolder").show())});$("#enableTwoFactor").click(function(){TWO_FACTOR_ON||getNewTwoFactor();$("#registerTwoFactor").prop("value","");$("#twoFactorModal").modal("show")});$("#changePassword").click(function(){$("#changePasswordModal").modal("show")});
$("#submitPasswordChange").click(function(){console.log("button clicked");new_password.value==new_password_confirm.value?change_password(old_password.value,new_password.value):alert("new password doesn't match confirmation")});$("#submitTwoFactor").click(function(){TWO_FACTOR_ON?disableTwoFactor(parseInt($("#registerTwoFactor").val())):registerTwoFactor(parseInt($("#registerTwoFactor").val()))});$("#suggestContractButton").click(function(){$("#suggestionModal").modal("show")});
$("input#search").keypress(function(a){13==(a.keyCode?a.keyCode:a.which)&&$("#searchButton").click()});$("#registerTwoFactor").keypress(function(a){13==(a.keyCode?a.keyCode:a.which)&&$("#submitTwoFactor").click()});$("input#chatBox.chatInput").keypress(function(a){13==(a.keyCode?a.keyCode:a.which)&&$("#chatButton").click()});$("#myModal").on("shown",function(){$("#login").focus()});$("#registerModal").on("shown",function(){$("#registerLogin").focus()});
$("#login").keypress(function(a){13==(a.keyCode?a.keyCode:a.which)&&$("#do_login_button").click()});$("#password").keypress(function(a){13==(a.keyCode?a.keyCode:a.which)&&$("#do_login_button").click()});$("#two_factor").keypress(function(a){13==(a.keyCode?a.keyCode:a.which)&&$("#do_login_button").click()});$(window).resize(welcome(MARKETS));
var session=null,base_uri="https://example.com/",get_chat_history_URI=base_uri+"procedures/get_chat_history",safe_price_URI=base_uri+"safe_price",get_safe_prices_URI=base_uri+"procedures/get_safe_prices",place_order_URI=base_uri+"procedures/place_order",get_trade_history_URI=base_uri+"procedures/get_trade_history",markets_URI=base_uri+"procedures/list_markets",positions_URI=base_uri+"procedures/get_positions",get_order_book_URI=base_uri+"procedures/get_order_book",make_account_URI=base_uri+"procedures/make_account",
get_open_orders_URI=base_uri+"procedures/get_open_orders",cancel_order_URI=base_uri+"procedures/cancel_order",register_two_factor_URI=base_uri+"procedures/register_two_factor",get_new_two_factor_URI=base_uri+"procedures/get_new_two_factor",disable_two_factor_URI=base_uri+"procedures/disable_two_factor",change_password_URI=base_uri+"procedures/change_password",get_new_address_URI=base_uri+"procedures/get_new_address",get_current_address_URI=base_uri+"procedures/get_current_address",withdraw_URI=base_uri+
"procedures/withdraw",AUTHEXTRA={keylen:32,salt:"RANDOM SALT",iterations:1E3};
function connect(){var a;a="file:"===window.location.protocol?"wss://localhost:8080":"wss://"+window.location.hostname+":8080";ab.connect(a,function(b){session=b;ab.log("connected to "+a);onConnect()},function(a,c,d){$("#loggedOut").modal("show");logout();session=null;switch(a){case ab.CONNECTION_UNSUPPORTED:window.location="https://autobahn.ws/unsupportedbrowser";break;case ab.CONNECTION_CLOSED:window.location.reload();break;default:ab.log(a,c,d)}},{maxRetries:1,retryDelay:1E3})}
function do_login(a,b){session.authreq(a).then(function(a){AUTHEXTRA=JSON.parse(a).authextra;console.log("challenge",JSON.parse(a).authextra);console.log(ab.deriveKey(b,JSON.parse(a).authextra));console.log(two_factor.value);var d=two_factor.value+ab.deriveKey(b,JSON.parse(a).authextra),d=ab.deriveKey(d,{iterations:10,keylen:32,salt:"onetimepass"});console.log(a);console.log(session.authsign(a,d));a=session.authsign(a,d);console.log(a);session.auth(a).then(onAuth,failed_login);console.log("end of do_login")},
function(a){failed_login("bad login")})}$("#do_login_button").click(function(){do_login(login.value,password.value)});function failed_login(a){$(".modal-backdrop").removeAttr("class","in");$("#login_error").attr("class","alert").text("Login error, please try again.");$("#loginButton").click()}
function logout(){logged_in=!1;$("#loggedInMenu").hide();$("#dLabel").text("");$("#loginButton").show();$("#registration").show();$("#Sputnik").click();$(".table").empty();SITE_POSITIONS=[];OPEN_ORDERS=[];AUTHEXTRA={};console.log(OPEN_ORDERS);session.close()}function getTradeHistory(a){a=new Date;(new Date(a.getTime())).setDate(a.getDate()-7);session.call(get_trade_history_URI,SITE_TICKER,604800).then(function(a){build_trade_graph(a);TRADE_HISTORY=a.reverse();tradeTable(TRADE_HISTORY,!0)})}
function getChatHistory(){session.call(get_chat_history_URI).then(function(a){for(chat in a)CHAT_MESSAGES.push(a[chat]);$("#chatArea").html(CHAT_MESSAGES.join("\n"));$("#chatArea").scrollTop($("#chatArea")[0].scrollHeight)})}function placeOrder(a){notifications.processing(a);session.call(place_order_URI,a).then(function(a){notifications.dismiss_processing(a);!1==a&&notifications.orderError()})}
function cancelOrder(a){session.call(cancel_order_URI,a).then(function(b){$("#cancel_order_row_"+a).addClass("warning");$("#cancel_button_"+order_id).attr("disabled","disabled").removeClass("btn-danger")})}
function getPositions(){session.call(positions_URI).then(function(a){SITE_POSITIONS=a;var b={},c={},d=_.pluck(OPEN_ORDERS,"ticker"),e;for(e in a)if("cash"==a[e].contract_type)b[e]=a[e];else if(0!=a[e].position||_.contains(d,a[e].ticker))c[e]=a[e];displayCash(!0,b);displayCash(!1,b);displayPositions(!0,c);displayPositions(!1,c)})}
function orderBook(a){console.log("in orderBook");session.call(get_order_book_URI,a).then(function(a){ORDER_BOOK=a;for(var c=[],d=[],e=0;e<a.length;e++)(0==a[e].order_side?c:d).push([Number(a[e].price),a[e].quantity]);c=stackBook(c);d=stackBook(d);d.reverse();graphTable(c,"buy",!0);graphTable(d,"sell",!0);suggestOrder()})}function withdraw(){session.call(withdraw_URI,"BTC",withdrawAddress.value,Math.round(1E8*Number(withdrawAmount.value))).then(function(a){console.log(a)})}$("#withdrawButton").click(function(){withdraw()});
function getCurrentAddress(){session.call(get_current_address_URI).then(function(a){console.log(a);$("#deposit_address").attr("href","bitcoin:"+a).text(a);$("#qrcode").empty();new QRCode(document.getElementById("qrcode"),"bitcoin:"+a)})}
function change_password(a,b){old_password_hash=ab.deriveKey(a,AUTHEXTRA);new_password_hash=ab.deriveKey(b,AUTHEXTRA);console.log(old_password_hash);session.call(change_password_URI,old_password_hash,new_password_hash).then(function(a){a?(alert("success!"),$(".modal").modal("hide")):alert("password reset failed")})}function getNewAddress(){session.call(get_new_address_URI).then(function(a){console.log(a)})}
function registerTwoFactor(a){notifications.processing("confirmation");session.call(register_two_factor_URI,a).then(function(a){notifications.dismiss_processing(a);console.log(a);a&&(two_factor.value="enabled",TWO_FACTOR_ON=!0,twoFactorSetting())})}function disableTwoFactor(a){session.call(disable_two_factor_URI,a).then(function(a){a&&(console.log("disabled"),two_factor.value="",TWO_FACTOR_ON=!1,twoFactorSetting())})}
function getNewTwoFactor(){session.call(get_new_two_factor_URI).then(function(a){console.log(a);console.log("otpauth://totp/Sputnik:"+login.value+"?secret="+a+"&issuer=SputnikMKT");$("#twoFactor").empty();new QRCode(document.getElementById("twoFactor"),"otpauth://totp/Sputnik:"+login.value+"?secret="+a+"&issuer=SputnikMKT")})}
function getOpenOrders(){console.log("Making getOpenOrders RPC call");session.call(get_open_orders_URI).then(function(a){console.log("Ended RPC call, drawing");OPEN_ORDERS=a;displayOrders(!0,a);displayOrders(!1,a)})}
function getMarkets(){console.log("in getMarkets");session.call(markets_URI).then(function(a){newMarketsToDisplay(a);MARKETS=a;welcome(MARKETS);$("#search").typeahead({source:_.keys(MARKETS)});a=[];for(key in MARKETS)a.push(key);setSiteTicker(a[Math.floor(a.length*Math.random())]);for(key in MARKETS)"futures"==MARKETS[key].contract_type&&session.subscribe(safe_price_URI+"#"+key,onSafePrice);console.log(SITE_TICKER)})}
function getSafePrices(){session.call(get_safe_prices_URI,[]).then(function(a){SAFE_PRICES=a})}function makeAccount(a,b,c,d){console.log("in make account");var e=Math.random().toString(36).slice(2);AUTHEXTRA.salt=e;b=ab.deriveKey(b,AUTHEXTRA);console.log("making session call for makeAccount");session.call(make_account_URI,a,b,e,c,d).then(function(a){login.value=registerLogin.value;a?do_login(registerLogin.value,registerPassword.value):alert("user name or email taken")})};
